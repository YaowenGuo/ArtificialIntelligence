# CoppeliaSim


## 模型

- 使用 CoppeliaSim 自带的模型。
- 自己创建新的模型
    - CoppeliaSim 创建简单的几何形状（建模能力比较弱，只有常见的几何形状）原始形状将针对动态交互进行优化，也可以直接动态启用。对于我们的应用来说，它可能没有包含足够的细节或几何精度。
    - 导入其它建模软件创建的模型（FreeCAD、Solidworks etc.）。最重要的是要确保CAD模型不会太重，即不会包含太多的三角形。我们建议建模一个机器人总共不超过2万个三角形。但大多数情况下，5000到10000个三角形更好。记住:在几乎所有方面，越少越好。

创建一个模型：

1. 首先要处理它的视觉方面

2. 运动方面（隐藏在简化、优化的模型之下的）：关节、传感器等将在后期处理。

### 导入其它建模软件创建的模型

CoppeliaSim 支持很多种模型文件格式，但导入后都转换为 Mesh 格式的模型。

步骤：

1. 视觉方面：
    1. 从三维制图软件中导出模型文件（如 STL、OBJ、甚至带装配结构的 URDF）
        - 从原始模型数据中移除所有孔、螺钉、对象内部等。
        - 导出具有有限精度的原始数据。如果有大组件和小组件，分别设置精度导出，避免大组件包含太过精确，小对象反而过于粗略。


    2. 导入到 CoppeliaSim。注意导入网格的方向。最好是保持原始的方向直至整个模型完全导入。这样在之后如果有其它模型需要导入时，就能相对先前导入的对象拥有正确的位置和方向。
        此阶段简化网格的方法：
        - 自动网格分割：将一个组件分割成不同的块。但并不是对所有的组件有效。[Menu bar --> Edit --> Shape grouping/merging --> divide]。如果自动分割有误，可以再合并[Menu bar --> Edit -> Shape grouping/merging --> merge]
        - 取出凸包： [Menu bar --> Edit --> Morph into convex shape(s)]
        - 提取凸分解网格： [Menu bar --> Edit --> Morph into convex decomposed shape(s)...].
        - 减少网格：可以执行多次 [Menu bar --> Edit --> Decimate shape(s)...]

        有时，使用提取凸包能让形状可能看起来更好。有时候，为了获得期望的结果，您将不得不迭代地使用上面描述的几种技术。

        对于将整个机器人作为一个模型导入的，在尝试多次执行上述步骤减少了三角形数量之后。这时候就需要按照运动节点将模型分成独立的组件。有两种不同的方式：

        - 自动网格分割： 即之前提到那个。该造作不总是有效，但总是值得一试。
        - 手工网格划分：通过 ` triangle edit mode`，手工选中三角形将其作为逻辑的归类，然后点击 `Extract shape`。这将在场景中生成一个新的形状。操作改步骤之后可以删除选中的三角形。

        此时，我们可以进一步优化/简化独立的形状。有时，如果使用凸包，形状可能看起来更好。其他时候，为了获得期望的结果，您将不得不迭代地使用上面描述的几种技术。为了消除一些孔洞，使用 `shape edit mode` 将零件划分为更小的块，然后擦掉作为洞的部分的三角形，然后分别提取凸包。最后使用 [Menu bar --> Edit --> Shape grouping/merging --> merge] 将其合并到一起变成一个零件。


如何知道模型当前的三角形数量？

1. 显示网格：Menu bar -> [Tools] -> [Scene object properties] -> 选中 Show Edges

2. 网格数量：Menu bar -> [Tools] -> [Scene object properties] -> [Geometry] 弹窗中可以查看顶点和三角形数量。

3. FreeCAD 导出减少三角形数量。FreeCAD 可以设置导出时最大的区分区间，却无法设置最小的划分。但是 FreeCAD 已经在不损失精度的情况下尽量减少三角形数量，例如长方体的每个面会被划分成两个三角形。[Preference -> Import-Export -> Mesh Formats 中设置]

    想要更精细的控制生成的网格粒度，可以使用 FreeCAD 的 Mesh 工作台。
    - 可以在将实体转换成  Mesh 的时候控制生成粒度 [Mesh workbench -> Create mesh from shape]，有几种不同的生方式。

    - 也可以使用选中网格对象，重新划分[Mesh workbench -> Refinement], 该工具需要自己安装一个 Gmsh 的 sdk。将对象划分达成更细的力度比较好用。想要划分的更粗粒度，不是太方便控制。

    - 减少三角形数量更方便时使用 [Mesh workbench -> Decimation]。该操作对于平面操作效果较好。但对于有圆滑对象和孔洞操作效果比较差。






2. 运动学方面：
    2. 添加关节，对齐到合适为止

    4. 选择对象合并或者组合成连杆

    5. 建立层次关系

要点：

1. 忽略次要部件，细节。

2. 关节的对齐：位姿。

#### 1. 导出模型

[STL、OBJ、AMF、3MF，4种3D打印文件格式区别](https://www.jianshu.com/p/12e22e6fda7d)

1. The orientation and size  of import model in  CoppeliaSim

STL座标必须是正数，没有尺度信息，且计量单位为任意的。


STL只能用来表示封闭的面或者体。


仿真不需要细节，只关注关节，对连杆，多于的螺丝、纹理、内部结构反而增加了仿真的计算难度，应该尽可能的减少细节。因此 STL 格式已经可以了。



#### 2. 导入模型 
